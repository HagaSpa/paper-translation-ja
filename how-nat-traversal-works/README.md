# How NAT traversal works
https://tailscale.com/blog/how-nat-traversal-works/

## Figuring out firewalls
* ファイアウォールに機能を持つサービスとして以下のようなものがある。
    * Windows Defender firewall
    * Ubuntu’s ufw (using iptables/nftables)
    * BSD’s pf (also used by macOS)
    * AWS  Security Groups
* これらの設定としてはinboundは全てブロックし、outboundは全て許可するのが一般的。
    * inboundはファイアウォール外から内へのアクセス
    * outboundはファイアウォール内から外へのアクセス
    * 例外としてinboundのSSHのみ許可する場合などもよくある。（現職でもそう）
* この概念はあくまでプロトコル上のものであり、実際のネットワーク上では双方向にアクセスが生まれている。
    * 物理的にファイアウォールがあるわけではなくて、２つの機器間での双方向の通信の間に論理的な概念としてファイアウォールがある。
* そのため各アクセスがinboundか？outboundか？はどのようにしてファイアウォールは判断するのか？
* これを解決するためにStateFul Firewallがある。
    * これは過去のパケットを記憶しており、その情報を用いてinboundかoutboundを判断できたり、各通信に対するコントロールが可能である。
* UDPをコントロールする場合以下を行う
    * 過去にあるアドレス:ポートがoutboundとして通信を行なっていた場合、その宛先からの戻りをinboundとして許可する。
    * あまり見ないが誰でもinboundとして通信を行ったアドレスと会話できる場合もある。


## Firewall face-off
* UDP通信をする場合、上記のルールは大した問題ではない。
* ただしファイアウォールの中にある端末から、通信を始めないとコネクションを開始できない。
* 例えば1つのサーバに対して、複数クライアントが紐付く所謂サーバ・クライアント形式の場合。(client -> server -> client)
    * VPNの世界ではサーバにVPNHubを導入し、クライアントは自身のファイアウォールを通してVPNHubへアクセスし、そこからサーバへ接続をする。
    * VPNHubが各ファイアウォールへアクセスできるように設定しておけば、常にどちらのクライアントからでも、接続を開始する事ができる。
* ただし両者が直接コネクションを結びたい時に問題が発生する。
    * 直接というのはVPNHub（サーバ）を経由しないで、クライアント同士がコネクションを結ぶ事
    * 先に述べたとおりファイアウォール越しに通信する場合、内部から外部へアクセスを開始しないと、外からのパケットは受け付けない。
    * そのためクライアントは相手に対してパケットを送るが、相手のファイアウォールはまだそのパケットを許可していないため弾かれる。
    * **つまり今まで一度もoutboundをしていない宛先のため、相手から投げられているパケットは一生受け付けられない。**
* これを回避する方法は？
    * ユーザにポート解放をお願いし、そのポートのinboundまたはどちらのパケットも通信可能にしてもらう。ファイアウォールの設定を再構成してもらう。
        * この記事でイメージするべきなのはDiscordなどのアプリだが、アプリでその実装はユーザペインになる。。。
    * メッシュネットワークではこの対応はできない。
    * そもそも大体の場合、ユーザは自身のファイアウォールを制御できないと見るのが常識的。
        * カフェのWifiを使用している場合など。
* そのためファイアウォールの設定変更を含まない対処法が必要となる。


## Finessing finicky firewalls
* 上述の通りStateFul Firewallのルールによると、UDPは**outboundのパケットが先にアクセスしない限り、inboundのパケットは絶対にアクセスできない。**
* しかしUDPはハンドシェイクを行わないので、outboundで送った先のIPやポートが正しくパケットを受け取れているか？の確認はしない。
* そのため送った先のIPやポートからのレスポンスに見えるアクセス（どういうこと？）は全てinboundとしてアクセスできる。
* お互いが必要な情報としてはIPアドレスとポート番号。
* staticな情報としてIP:PORTを固定してもいいが、一般的にはCoordination Serverで柔軟に管理できる
